---
phase: 01-ui-state-onboarding
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - popup/popup.html
  - popup/popup.js
autonomous: true
user_setup: []

must_haves:
  truths:
    - "First-time user opens extension and sees onboarding mode (only CV upload + API key inputs)"
    - "Returning user with stored data sees ready mode immediately"
    - "Settings mode can be accessed from ready mode"
    - "UI shows only one mode at a time (onboarding, ready, or settings)"
  artifacts:
    - path: "popup/popup.html"
      provides: "Three mode sections (onboarding, ready, settings)"
      contains:
        - "onboarding-section"
        - "ready-section"
        - "settings-section"
    - path: "popup/popup.js"
      provides: "State detection and mode management"
      exports: ["detectCurrentMode", "switchMode", "checkOnboardingProgress"]
  key_links:
    - from: "popup/popup.js (init)"
      to: "chrome.storage.local"
      via: "get([cvMetadata, openaiApiKey])"
      pattern: "chrome\\.storage\\.local\\.get.*cvMetadata.*openaiApiKey"
    - from: "popup/popup.js"
      to: "popup/popup.html"
      via: "setDisplayMode() sets display: block/none on sections"
      pattern: "onboardingSection\\.style\\.display|readySection\\.style\\.display"
---

<objective>
Add state detection and three-mode UI structure (onboarding, ready, settings) to popup.

Purpose: Enable intelligent UI based on user's setup state - show onboarding for first-time users, ready mode for returning users with data, and settings for updates.

Output: HTML with three mode sections and JavaScript with mode detection/switching logic.
</objective>

<execution_context>
@C:\Users\tahas\.config\opencode/get-shit-done/workflows/execute-plan.md
@C:\Users\tahas\.config\opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md

# Current Implementation
@popup/popup.js
@popup/popup.html

# Codebase Patterns
@.planning/codebase/CONVENTIONS.md
@.planning/codebase/ARCHITECTURE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add three-mode HTML structure to popup.html</name>
  <files>popup/popup.html</files>
  <action>
    Add three mode sections (onboarding, ready, settings) to replace current single-mode layout:

    1. **Onboarding Section** (new):
       - Wrap CV upload and API key inputs in `<section id="onboardingSection">`
       - Add clear instructions above each input:
         - CV section: "Step 1: Upload your CV (PDF or DOCX)"
         - API key section: "Step 2: Add your Gemini API key"
       - Add progress indicator at top: `<div class="onboarding-progress">Setup: 0/2 complete</div>`
       - Keep CV upload button, file input, CV status display
       - Keep API key input field
       - Remove existing settings panel (will be moved to settings section)

    2. **Ready Section** (new):
       - Wrap existing main section in `<section id="readySection" style="display: none;">`
       - Keep: Tailor button, hint text, status message
       - Add settings button (move existing settingsBtn to ready section)
       - Add status text: "Ready to generate cover letters!"

    3. **Settings Section** (new):
       - Wrap settings content in `<section id="settingsSection" style="display: none;">`
       - Add header: `<h2>Settings</h2>`
       - Add close button: `<button id="closeSettingsBtn">×</button>`
       - Include CV upload (same as onboarding, for updates)
       - Include API key input (same as onboarding, for updates)
       - Add delete CV button

    4. **Container cleanup**:
       - Keep header with "TailorAI" title (visible in all modes)
       - Remove old settingsPanel (replaced by settingsSection)
       - Keep messageSection (visible in all modes)
       - Keep all existing IDs for DOM elements (cvUpload, apiKey, tailorBtn, etc.)

    Maintain existing styling classes. No emoji replacements yet (Phase 2).
  </action>
  <verify>
    Open popup.html and verify:
    - Three sections exist: onboardingSection, readySection, settingsSection
    - readySection and settingsSection have style="display: none;"
    - onboardingSection has CV upload, API key, progress indicator
    - readySection has Tailor button, settings button
    - settingsSection has CV upload, API key, close button
    - All existing IDs are preserved (cvUpload, apiKey, tailorBtn, etc.)
  </verify>
  <done>
    popup.html has three mode sections with proper display defaults and required UI elements
  </done>
</task>

<task type="auto">
  <name>Task 2: Add state detection and mode switching to popup.js</name>
  <files>popup/popup.js</files>
  <action>
    Add state detection and mode switching logic to popup.js:

    1. **Add mode constants** at top of file (after DOM element declarations):
       ```javascript
       // UI Modes
       const MODES = {
         ONBOARDING: 'onboarding',
         READY: 'ready',
         SETTINGS: 'settings'
       };
       let currentMode = null;
       ```

    2. **Add DOM element references** for new sections (after existing DOM elements):
       ```javascript
       const onboardingSection = document.getElementById('onboardingSection');
       const readySection = document.getElementById('readySection');
       const settingsSection = document.getElementById('settingsSection');
       const onboardingProgress = document.querySelector('.onboarding-progress');
       ```

    3. **Add detectCurrentMode() function** (before init()):
       ```javascript
       async function detectCurrentMode() {
         const result = await chrome.storage.local.get(['cvMetadata', 'openaiApiKey']);
         const hasCV = !!result.cvMetadata;
         const hasApiKey = !!result.openaiApiKey;

         if (!hasCV || !hasApiKey) {
           return MODES.ONBOARDING;
         }
         return MODES.READY;
       }
       ```

    4. **Add switchMode() function** (after detectCurrentMode()):
       ```javascript
       function switchMode(mode) {
         currentMode = mode;

         // Hide all sections
         onboardingSection.style.display = 'none';
         readySection.style.display = 'none';
         settingsSection.style.display = 'none';

         // Show current section
         switch (mode) {
           case MODES.ONBOARDING:
             onboardingSection.style.display = 'block';
             break;
           case MODES.READY:
             readySection.style.display = 'block';
             updateStatusMessage('✅', 'Ready to generate cover letters!', 'success');
             break;
           case MODES.SETTINGS:
             settingsSection.style.display = 'block';
             break;
         }
       }
       ```

    5. **Update init() function** to use mode detection:
       - Remove: `await checkCVStatus()` (will be called by mode-specific logic)
       - Replace with:
         ```javascript
         const mode = await detectCurrentMode();
         switchMode(mode);
         await loadApiKey();
         updateOnboardingProgress();
         setupEventListeners();
         ```

    6. **Add openSettings() function** (modify existing):
       - Change: `settingsPanel.style.display = 'block'` to `switchMode(MODES.SETTINGS)`

    7. **Add closeSettings() function** (modify existing):
       - Change: `settingsPanel.style.display = 'none'` to `switchMode(MODES.READY)`

    8. **Add updateOnboardingProgress() function** (new):
       ```javascript
       async function updateOnboardingProgress() {
         const result = await chrome.storage.local.get(['cvMetadata', 'openaiApiKey']);
         const hasCV = !!result.cvMetadata;
         const hasApiKey = !!result.openaiApiKey;
         const progressCount = (hasCV ? 1 : 0) + (hasApiKey ? 1 : 0);

         if (onboardingProgress) {
           onboardingProgress.textContent = `Setup: ${progressCount}/2 complete`;
         }

         // Auto-transition to ready mode if both complete
         if (hasCV && hasApiKey && currentMode === MODES.ONBOARDING) {
           switchMode(MODES.READY);
         }
       }
       ```

    Keep all existing functions (handleCVUpload, handleSaveApiKey, etc.) unchanged for now (will update in Plan 02).
  </action>
  <verify>
    Run extension and verify:
    - First-time user (no CV, no API key) → onboarding mode shows
    - Returning user (CV + API key stored) → ready mode shows immediately
    - Click settings button → switches to settings mode
    - Click close settings button → returns to ready mode
  </verify>
  <done>
    popup.js detects user state correctly and switches between onboarding, ready, and settings modes
  </done>
</task>

</tasks>

<verification>
Overall phase checks:
1. Extension loads in correct mode based on stored data
2. Mode switching works via settings button and close button
3. Only one section visible at a time
4. Progress indicator updates when CV or API key is stored
5. Auto-transition to ready mode when onboarding completes
</verification>

<success_criteria>
1. First-time users see onboarding mode with CV upload + API key inputs
2. Returning users with stored data see ready mode with Tailor button
3. Settings mode accessible from ready mode
4. UI transitions smoothly between modes (no flickering)
5. Progress indicator shows setup stage (0/2, 1/2, 2/2)
6. Auto-transition to ready mode when onboarding completes
</success_criteria>

<output>
After completion, create `.planning/phases/01-ui-state-onboarding/01-01-SUMMARY.md`
</output>
