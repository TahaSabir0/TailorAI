---
phase: 01-ui-state-onboarding
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - popup/popup.js
  - popup/popup.css
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Onboarding mode displays clear instructions for CV upload process"
    - "Onboarding mode displays clear instructions for API key entry process"
    - "Progress indicator updates as user completes each step"
    - "After successful onboarding, UI transitions to ready mode"
    - "Settings mode allows updating CV and API key"
    - "User can return to ready mode from settings"
  artifacts:
    - path: "popup/popup.js"
      provides: "Onboarding logic and step tracking"
      exports: ["updateOnboardingProgress", "updateCVStatusDisplay", "handleCVUpload", "handleSaveApiKey"]
    - path: "popup/popup.css"
      provides: "Onboarding-specific styling"
      contains: [".onboarding-section", ".onboarding-progress", ".step-instruction"]
  key_links:
    - from: "handleCVUpload"
      to: "updateOnboardingProgress"
      via: "called after successful CV upload"
      pattern: "updateOnboardingProgress\\(\\)"
    - from: "handleSaveApiKey"
      to: "updateOnboardingProgress"
      via: "called after successful API key save"
      pattern: "updateOnboardingProgress\\(\\)"
    - from: "updateOnboardingProgress"
      to: "switchMode"
      via: "auto-transitions to ready mode when complete"
      pattern: "switchMode\\(MODES\\.READY\\)"
---

<objective>
Implement onboarding logic with step tracking, progress updates, and mode-aware event handling.

Purpose: Guide users through onboarding with clear feedback, update progress in real-time, and ensure smooth transitions when setup is complete.

Output: Working onboarding flow with progress tracking, mode-aware handlers, and transitions to ready mode.
</objective>

<execution_context>
@C:\Users\tahas\.config\opencode/get-shit-done/workflows/execute-plan.md
@C:\Users\tahas\.config\opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md

# Current Implementation (after Plan 01)
@popup/popup.js
@popup/popup.html

# Prior Plan Summary
@.planning/phases/01-ui-state-onboarding/01-01-SUMMARY.md

# Codebase Patterns
@.planning/codebase/CONVENTIONS.md
@.planning/codebase/ARCHITECTURE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update event handlers to work in both onboarding and settings modes</name>
  <files>popup/popup.js</files>
  <action>
    Modify existing event handlers to work contextually in both onboarding and settings modes:

    1. **Update setupEventListeners() function**:
       - Keep all existing event listener registrations
       - Ensure settingsBtn and closeSettingsBtn are present in readySection and settingsSection
       - No changes needed to event bindings (DOM elements have same IDs)

    2. **Modify handleCVUpload() function** (lines 99-167):
       - Remove: `showMessage('Please add your Gemini API key in settings first', 'error')` and `openSettings()` call
       - Replace with: `showMessage('Please enter your API key first (Step 2)', 'info')`
       - After successful CV upload (line 158), add: `await updateOnboardingProgress();`
       - Keep all other logic unchanged (validation, extraction, storage)

    3. **Modify handleSaveApiKey() function** (lines 201-223):
       - After successful API key save (line 218), add: `await updateOnboardingProgress();`
       - Keep all other logic unchanged (validation, storage)

    4. **Modify handleDeleteCV() function** (lines 170-187):
       - After successful CV deletion (line 182), add: `await updateOnboardingProgress();`
       - Keep all other logic unchanged (confirmation, storage cleanup)

    5. **Update updateCVStatusDisplay() function** (lines 60-70):
       - Ensure it works in both onboardingSection and settingsSection (same CSS class)
       - No changes needed (DOM element has same ID across sections)

    6. **Update updateOnboardingProgress() function** (already added in Plan 01, verify it works):
       - Ensure it checks storage for cvMetadata and openaiApiKey
       - Update progress indicator text
       - Call switchMode(MODES.READY) when both complete
       - No changes needed if already implemented correctly

    All handlers should now work in both modes without hardcoded mode-specific logic.
  </action>
  <verify>
    Test the following flows:
    1. Onboarding mode: Upload CV → progress updates to 1/2 → add API key → progress updates to 2/2 → auto-transition to ready mode
    2. Ready mode: Click settings → upload new CV → CV updated → click close → return to ready mode
    3. Ready mode: Click settings → update API key → API key updated → click close → return to ready mode
    4. Settings mode: Delete CV → progress indicator shows 0/2 → can re-upload CV
  </verify>
  <done>
    Event handlers work in both onboarding and settings modes, progress updates trigger correctly
  </done>
</task>

<task type="auto">
  <name>Task 2: Add onboarding-specific CSS styling</name>
  <files>popup/popup.css</files>
  <action>
    Add CSS classes for onboarding-specific elements:

    1. **Onboarding section styling**:
       ```css
       .onboarding-section {
         background: #ffffff;
         border-radius: 16px;
         padding: 24px;
         box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06), 0 1px 2px rgba(0, 0, 0, 0.04);
         border: 1px solid rgba(0, 0, 0, 0.04);
       }
       ```

    2. **Progress indicator styling**:
       ```css
       .onboarding-progress {
         background: #f5f5f7;
         border-radius: 10px;
         padding: 12px 16px;
         margin-bottom: 20px;
         text-align: center;
         font-size: 14px;
         font-weight: 600;
         color: #1d1d1f;
         border: 1px solid rgba(0, 0, 0, 0.04);
         letter-spacing: -0.2px;
       }

       .onboarding-progress.complete {
         background: #e8f5e9;
         color: #1b5e20;
         border-color: #4caf50;
       }
       ```

    3. **Step instruction styling**:
       ```css
       .step-instruction {
         font-size: 14px;
         font-weight: 600;
         color: #1d1d1f;
         margin-bottom: 8px;
         letter-spacing: -0.2px;
       }

       .step-number {
         color: #007aff;
         font-weight: 700;
       }
       ```

    4. **Settings section styling** (reuse existing .settings-panel styling, add section-specific class):
       ```css
       .settings-section {
         background: #ffffff;
         border-radius: 16px;
         padding: 24px;
         box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08), 0 1px 3px rgba(0, 0, 0, 0.06);
         border: 1px solid rgba(0, 0, 0, 0.04);
       }
       ```

    5. **Mode-specific header styling**:
       ```css
       .mode-header {
         display: flex;
         justify-content: space-between;
         align-items: center;
         margin-bottom: 24px;
         padding-bottom: 16px;
         border-bottom: 1px solid rgba(0, 0, 0, 0.06);
       }

       .mode-header h2 {
         font-size: 20px;
         font-weight: 600;
         color: #1d1d1f;
         letter-spacing: -0.4px;
       }
       ```

    Add these CSS classes to popup.css at the end (after existing styles).
  </action>
  <verify>
    Apply CSS classes to HTML elements (if not already done in Plan 01):
    - onboardingSection should have class="onboarding-section"
    - settingsSection should have class="settings-section"
    - onboardingProgress should have class="onboarding-progress"
    - Add step instructions with class="step-instruction"

    Verify visual appearance:
    - Progress indicator is prominent and centered
    - Step instructions are clear and readable
    - Settings section looks distinct from onboarding
  </verify>
  <done>
    Onboarding and settings modes have distinct, professional styling matching Apple aesthetic
  </done>
</task>

</tasks>

<verification>
Overall phase checks:
1. Onboarding flow works end-to-end (upload CV → add API key → transition to ready)
2. Progress indicator updates at each step (0/2 → 1/2 → 2/2)
3. Settings mode allows updating CV and API key
4. User can return to ready mode from settings
5. Visual feedback is clear at each stage
6. No errors in console during mode transitions
</verification>

<success_criteria>
1. First-time user completes onboarding successfully with clear feedback
2. Progress indicator accurately reflects setup completion
3. Auto-transition to ready mode occurs when onboarding completes
4. Settings mode works for updating both CV and API key
5. Mode transitions are smooth (no flickering, no UI glitches)
6. All UIST-01→05 and ONBD-01→06 requirements met
</success_criteria>

<output>
After completion, create `.planning/phases/01-ui-state-onboarding/01-02-SUMMARY.md`
</output>
